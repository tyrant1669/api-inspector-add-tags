{% extends "base.html" %}
{% block title %}Saved APIs{% endblock %}

{% block head %}
{{ super() }}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container--default .select2-selection--single {
        height: 28px;
        padding: 3px 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 26px;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 22px;
        padding-left: 8px;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2 for all tag selects
        $('.tag-select').select2({
            placeholder: 'Select a tag...',
            allowClear: true,
            width: '200px',
            dropdownAutoWidth: true,
            theme: 'default',
            tags: false,  // Disable tag creation
            createTag: null  // Remove tag creation function
        });

        // Initialize Select2 for the filter dropdown
        $('select[name="tag"]').select2({
            placeholder: 'Filter by tag',
            allowClear: true,
            width: '200px',
            theme: 'default'
        });

        // Function to show flash message
        function showFlashMessage(message, type) {
            // Create flash message element
            var $flash = $('<div class="alert alert-' + (type === 'error' ? 'danger' : 'success') + ' alert-dismissible fade show" role="alert">' +
                         message +
                         '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                         '<span aria-hidden="true">&times;</span></button></div>');
            
            // Add to the top of the content
            $('div.container').first().prepend($flash);
            
            // Auto-remove after 5 seconds
            setTimeout(function() {
                $flash.fadeOut(400, function() {
                    $(this).remove();
                });
            }, 5000);
        }

        // Handle form submission
        $(document).on('submit', '.tag-form', function(e) {
            e.preventDefault();
            var $form = $(this);
            var $select = $form.find('select');
            var $submitBtn = $form.find('button[type="submit"]');
            
            // Only submit if a tag is actually selected
            if ($select.val()) {
                // Disable the select to prevent multiple submissions
                $select.prop('disabled', true);
                if ($submitBtn.length) {
                    $submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...');
                }
                
                $.ajax({
                    type: 'POST',
                    url: $form.attr('action'),
                    data: $form.serialize(),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': $form.find('input[name="csrf_token"]').val()
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            showFlashMessage(response.message || 'Tag updated successfully', 'success');
                            // Update the UI without reloading
                            if (response.tag) {
                                // Update the selected option and its text
                                var $option = $select.find('option[value="' + response.tag.id + '"]');
                                if ($option.length === 0) {
                                    // If option doesn't exist, add it
                                    $select.append(new Option(response.tag.name, response.tag.id, true, true));
                                } else {
                                    // Update existing option
                                    $option.text(response.tag.name).prop('selected', true);
                                }
                                $select.trigger('change');
                            }
                        } else {
                            showFlashMessage(response.error || 'Failed to update tag', 'error');
                        }
                    },
                    error: function(xhr) {
                        var errorMsg = 'Error updating tag: ';
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response && response.error) {
                                errorMsg = response.error;
                            } else if (xhr.statusText) {
                                errorMsg += xhr.statusText;
                            }
                        } catch (e) {
                            console.error('Error parsing error response:', e);
                            errorMsg += 'Unknown error';
                        }
                        showFlashMessage(errorMsg, 'error');
                    },
                    complete: function() {
                        // Re-enable the select
                        $select.prop('disabled', false);
                        if ($submitBtn.length) {
                            $submitBtn.prop('disabled', false).text('Update');
                        }
                    }
                });
            }
            return false;
        });
    });
</script>
{% endblock %}

{% block content %}
<div style="font-family: Arial; padding: 20px; background: #f7f7f7;">
    <h2>Saved APIs</h2>

    <div style="margin-bottom: 20px;">
        <h3>Filters</h3>
        <form method="get" action="{{ url_for('saved_apis') }}" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px;">
            <!-- URL Search Filter -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Search URL:</label>
                <input type="text" 
                       name="url" 
                       value="{{ current_url_filter or '' }}" 
                       placeholder="Enter URL to filter..." 
                       style="padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px;"
                       onchange="this.form.submit()">
                {% if current_url_filter %}
                    <a href="{{ url_for('saved_apis') }}{% if request.args.get('tag') %}?tag={{ request.args.get('tag') }}{% endif %}" 
                       style="color: #dc3545; text-decoration: none; margin-left: 5px; font-size: 0.9em;">
                        Clear
                    </a>
                {% endif %}
            </div>

            <!-- Tag Dropdown Filter -->
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Filter by Tag:</label>
                <select name="tag" class="tag-select" style="min-width: 200px;">
                    <option value="">All Tags ({{ total_apis }})</option>
                    {% for tag, count in all_tags_with_counts %}
                        <option value="{{ tag.name }}" {% if request.args.get('tag') == tag.name|string %}selected{% endif %}>
                            {{ tag.name }} ({{ count }})
                        </option>
                    {% endfor %}
                </select>
                {% if request.args.get('tag') %}
                    <a href="{{ url_for('saved_apis') }}{% if current_url_filter %}?url={{ current_url_filter }}{% endif %}" 
                       style="color: #dc3545; text-decoration: none; margin-left: 5px; font-size: 0.9em;">
                        Clear
                    </a>
                {% endif %}
            </div>

            <!-- Hidden fields to maintain other filters -->
            {% if current_url_filter %}
                <input type="hidden" name="url" value="{{ current_url_filter }}">
            {% endif %}
        </form>
    </div>

    <!-- Keep the tag pills for backward compatibility -->
    {% if tags %}
    <div style="margin-bottom: 20px;">
        <h3>Quick Tag Filters:</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px;">
            <a href="{{ url_for('saved_apis') }}" 
               style="display: inline-block; 
                      padding: 4px 12px; 
                      background: {% if not request.args.get('tag') %}#007bff; color: white;{% else %}#e1ecf4; color: #39739d;{% endif %}; 
                      border-radius: 15px; 
                      font-size: 0.9em; 
                      text-decoration: none;">
                All ({{ total_apis }})
            </a>
            {% for tag, count in all_tags_with_counts %}
            <a href="{{ url_for('saved_apis', tag=tag.name) }}" 
               style="display: inline-block; 
                      padding: 4px 12px; 
                      background: {% if request.args.get('tag') == tag.name %}#007bff; color: white;{% else %}#e1ecf4; color: #39739d;{% endif %}; 
                      border-radius: 15px; 
                      font-size: 0.9em; 
                      text-decoration: none;">
                {{ tag.name }} ({{ count }})
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if apis %}
    <table style="width: 100%; border-collapse: collapse; background: white; margin-top: 20px; border: 1px solid #ccc;">
        <tr style="background: #eee;">
            <th style="padding: 10px; border: 1px solid #ccc;">ID</th>
            <th style="padding: 10px; border: 1px solid #ccc;">API URL</th>
            <th style="padding: 10px; border: 1px solid #ccc;">Actions</th>
        </tr>
        {% for api in apis %}
        <tr>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ api.id }}</td>
            <td style="padding: 10px; border: 1px solid #ccc;">{{ api.api }}</td>
            <td style="padding: 10px; border: 1px solid #ccc; white-space: nowrap;">
                <a href="{{ url_for('view_saved_api', api_id=api.id) }}" style="color: #007bff; text-decoration: none;">View</a> | 
                <a href="{{ url_for('delete_api', api_id=api.id) }}" 
                   onclick="return confirm('Are you sure you want to delete this API and all related mappings?');"
                   style="color: #007bff; text-decoration: none;">
                    Delete
                </a>
                <form action="{{ url_for('update_api_tag', api_id=api.id) }}" method="POST" style="display: inline-block; margin-left: 10px;" class="tag-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select name="tag_id" class="tag-select" style="min-width: 200px;" required>
                        <option value="">Select a tag...</option>
                        {% for tag in all_tags %}
                            <option value="{{ tag.id }}"
                                {% if api.tag and tag.id == api.tag.id %}selected{% endif %}>
                                {{ tag.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary" style="margin-left: 5px;">Update</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <div style="padding: 20px; text-align: center; color: #6c757d; background: white; border: 1px solid #ccc; margin-top: 20px;">
        <p>No APIs found{% if request.args.get('tag') %} with the selected tag{% else %} yet{% endif %}.</p>
    </div>
    {% endif %}

    <br>
    <a href="/" style="color: #000; text-decoration: none;">â¬… Back to Home</a>
</div>
{% endblock %}
